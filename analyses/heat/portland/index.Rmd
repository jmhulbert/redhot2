---
title: "Binomial Distribution Response to Urban Heat - Portland"
date: "2025-10-06"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 3
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(corrplot)
library(knitr)
library(kableExtra)
library(gghalves)
library(patchwork)
library(scales)
library(glmmTMB)
library(bbmle)
library(DHARMa)
```

# Portland

# Purpose

The purpose of this page is to summarize an investigation of **tree health categories** as a *categorical* response to urban heat (temperatures) for observations affed from Portland, Oregon.

Response variable: category: *healthy, unhealthy*

*Response variables*
Binary health: healthy, unhealthy
Binary dead top: no top dieback, top dieback
Binary thinning: no thinning, thinning



# Data Wrangling

```{r}
data <- read.csv('https://raw.githubusercontent.com/jmhulbert/redhot2/refs/heads/main/data/urban-data-modified.csv')
```



## Remove dead trees

```{r}
# Remove Dead Trees
data.w.dead <- data 
data <- data %>% filter(field.tree.canopy.symptoms!="Tree is dead") %>% filter(field.dieback.percent<100) %>% droplevels()
```

`r nrow(data.w.dead)-nrow(data)` trees were dead

```{r}
data$binary.tree.canopy.symptoms <- as.factor(data$binary.tree.canopy.symptoms)
levels(data$binary.tree.canopy.symptoms)
```



## Filter to Portland Data


```{r}
data <- data %>% filter(Area=="Portland") %>% droplevels()
```

`r nrow(data)` trees were included in portland


## Subset data from parks

```{r}
parks <-data %>% filter(str_detect(place_guess, "Park") | str_detect(place_guess, "park") | str_detect(place_guess, "Hoyt") |str_detect(place_guess, "hoyt")) %>% mutate(park = str_remove(place_guess, ",.*"))
levels(as.factor(parks$park))
```

## Observations from Hoyt

```{r}
hoyt.data <- data %>% filter(str_detect(place_guess, "Hoyt") |str_detect(place_guess, "hoyt"))
```

`r nrow(hoyt.data)` trees were from hoyt


## Remove observations from Hoyt

```{r}
data <- data %>% filter(!str_detect(place_guess, "Hoyt") & !str_detect(place_guess, "hoyt"))
```


# Visualize Portland Data

## All Portland

```{r}
#ggplot(data,aes(binary.tree.canopy.symptoms,pl.af.f,fill=binary.tree.canopy.symptoms))+geom_violin()+coord_flip()+theme_bw()+ scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE)
```



```{r}
p1 <- ggplot(data,aes(binary.tree.canopy.symptoms,fill=binary.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()+ scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE)
```




```{r}
p2 <- ggplot(data,aes(reclassified.tree.canopy.symptoms))+geom_histogram(stat="count")+theme_bw()+coord_flip()
```

```{r}
p1 + p2
```


```{r}
#p3 <- ggplot(data,aes(binary.tree.canopy.symptoms)) +facet_wrap(~field.optional...tree.size) +geom_histogram(stat="count")+theme_bw()+coord_flip()
#p3
```

```{r}
#p4 <- ggplot(data,aes(binary.tree.canopy.symptoms)) +facet_wrap(~field.optional...site.location.description) +geom_histogram(stat="count")+theme_bw()+coord_flip()
#p4
```



```{r}
p5 <-ggplot(data,aes(binary.tree.canopy.symptoms,pl.af.f, fill=binary.tree.canopy.symptoms ))+geom_boxplot(alpha=0.5)+theme_bw()+coord_flip() + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Tree Condition",y=NULL)
```

```{r}
p6 <-ggplot(data,aes(pl.af.f,fill=binary.tree.canopy.symptoms))+geom_density(alpha=0.5) + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929")) +theme_bw() +labs(x="Afternoon Temperature") +guides(fill=FALSE)
```

```{r}
p5 / p6
```


## Parks Observations

```{r}

parks$park[parks$park=="Washington park"] <-"Washington Park"
parks <- parks %>% filter(park!="NE Hoyt St") %>% filter(park!="TriMet Washington Park MAX Station")
```

```{r}
ggplot(parks,aes(park,fill=binary.tree.canopy.symptoms))+geom_histogram(stat="count") +coord_flip() + guides(fill="none") + theme_bw() +scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))
```


```{r}
parks.no.hoyt <- parks %>% filter(!str_detect(place_guess, "Hoyt") & !str_detect(place_guess, "hoyt"))
```


```{r}
ggplot(parks.no.hoyt,aes(park,fill=binary.tree.canopy.symptoms))+geom_histogram(stat="count") +coord_flip() + guides(fill="none") + theme_bw() +scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))
```

```{r}
parks <- parks %>% filter(park =="Gabriel Park" | park== "Hoyt Arboretum"| park== "Mt. Tabor Park"| park== "Washington Park" | park=="Willamette Park" | park=="Forest Park Conservancy" | park=="Columbia Park and Annex")
```

```{r}
ggplot(parks,aes(park,fill=binary.tree.canopy.symptoms))+geom_histogram(stat="count") +coord_flip() + guides(fill="none") + theme_bw() +scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))
```


```{r fig.height=7.5, fig.width=5}
ggplot(parks,aes(binary.tree.canopy.symptoms,pl.af.f, fill=binary.tree.canopy.symptoms ))+geom_boxplot(alpha=0.5) +facet_wrap(~park,ncol=1) +theme_bw()+coord_flip() + scale_fill_manual(name="Tree Condition",values=c("#7fcdbb","#fe9929"))+guides(fill=FALSE) +labs(x="Tree Condition",y=NULL)
```


```{r}
parks.summary <- parks %>% group_by(park) %>% summarize(n=n(),n.healthy=sum(binary.tree.canopy.symptoms == "Healthy", na.rm = TRUE),n.unhealthy=sum(binary.tree.canopy.symptoms == "Unhealthy", na.rm = TRUE)) %>% mutate(prop.unhealthy =n.unhealthy/n.healthy)
parks.summary
```



```{r}
ggplot(parks.summary,aes(park,prop.unhealthy))+geom_col()+coord_flip()+theme_bw()+geom_text(aes(label=n),hjust = -0.5)
```




# Analyses


```{r}
data$top.dieback <- as.factor(data$top.dieback)
data$thinning <- as.factor(data$thinning)
```


Models were created with data after removing hoyt 
 
## Temperature Time Periods

```{r}
binomial.daily <- glmmTMB(binary.tree.canopy.symptoms ~ mean.temp.daily.f ,family=binomial,data=data)
binomial.am <- glmmTMB(binary.tree.canopy.symptoms ~ pl.am.f ,data=data,family=binomial)
binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ pl.af.f ,data=data,family=binomial)
binomial.pm <- glmmTMB(binary.tree.canopy.symptoms ~ pl.pm.f,data=data,family=binomial)
```

### Best Fit Comparison

```{r}
AICtab(binomial.daily,binomial.am,binomial.af,binomial.pm)
```

Afternoon heat was the best fit


## Response 1.0: healthy / unhealthy

```{r}
binomial.af <- glmmTMB(binary.tree.canopy.symptoms ~ pl.af.f ,data=data,family=binomial)
```


### Summary

```{r}
summary(binomial.af)
```

Tree health is associated with urban heat. The probability of success (tree categorized as unhealthy) increases with urban heat

Unhealthy trees are considered success (1) because it is the second level. The probability of failure (0) is the first level (Healthy).

```{r}
levels(data$binary.tree.canopy.symptoms)
```

The probability of a tree being classified as unhealthy increases with urban temperature. 


### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data <- expand.grid(
  pl.af.f = seq(min(data$pl.af.f), max(data$pl.af.f), length.out = 100)  # keeping predictor2 constant at its mean
)
```

```{r}
head(new.data)
```

```{r}
new.data$predicted_response <- predict(binomial.af, newdata = new.data, type = "response")
```

```{r}
head(new.data)
```

```{r}
ggplot(new.data, aes(x = pl.af.f, y = predicted_response)) +
  geom_line() +
  labs(x = "Afternoon Temperature", y = "Predicted Response") +
  theme_bw()
```

The probability of tree being classified as unhealthy increases with afternoon temperature


---

## Response 2.0: healthy / top-dieback

```{r}
data.top <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Dead Top") %>% droplevels()
```


```{r}
top.dieback.binomial.af <- glmmTMB(top.dieback ~ pl.af.f,data=data.top,family=binomial)
```

### Summary

```{r}
summary(top.dieback.binomial.af)
```


```{r}
levels(data$top.dieback)
```

The probability of a tree having top dieback increases with urban temperature. 

### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.2 <- expand.grid(
  pl.af.f = seq(min(80), max(150), length.out = 1000)  # keeping predictor2 constant at its mean
)
```


```{r}
head(new.data.2)
```


```{r}
new.data.2$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2, type = "response")
```

```{r}
# Create a data frame for predictions
new.data.2.inf <- expand.grid(
  pl.af.f = seq(min(data.top$pl.af.f), max(150), length.out = 1000)  # keeping predictor2 constant at its mean
)
```

```{r}
new.data.2.inf$predicted_response <- predict(top.dieback.binomial.af, newdata = new.data.2.inf, type = "response")
```


```{r}
p <- ggplot(new.data.2.inf, aes(x = pl.af.f, y = predicted_response)) + geom_line() + labs(x = "Afternoon temperature (F)", y = "Dieback Probability") + scale_x_continuous(limits = c(80, 115)) +theme_minimal()

p
```


### Calculate Dieback Probability Categories


```{r}
head(new.data.2[new.data.2$pl.af.f<85.5 & new.data.2$pl.af.f>84.75,])
```

Portland redcedar at 85 degrees had a 0.03 probability

```{r}
head(new.data.2[new.data.2$predicted_response>0.023 & new.data.2$predicted_response<0.027,])
```


Portland redcedar at 84.32 degrees had a 0.025 probability

```{r}
head(new.data.2[new.data.2$predicted_response>0.048 & new.data.2$predicted_response<0.052,])
```

Portland trees at 86.48 had about a 0.05 probability

```{r}
head(new.data.2[new.data.2$predicted_response>0.09,])
```

Portland redcedar at about 88.5 degrees had a 0.1 predicted response. 


```{r}
head(new.data.2[new.data.2$predicted_response>0.195 & new.data.2$predicted_response<0.205,])
```

Portland redcedar at about 91.66 degrees had a 0.25 predicted response. 


* Portland Dieback Probability Categories (25%)
  + Most Concern (>25%): >91.66
  + Moderate Concern (3-25%): 86.48- 91.66
  + Lowest Concern (<5%): <86.48


* Portland Top-Dieback Probability Categories (10%)
  + Most Concern (>10%): > 88.5
  + Moderate Concern (5-10%): 84.32-88.5
  + Lowest Concern (<2.5%): DN_AF <84.32 



```{r}
p <- ggplot(new.data.2, aes(x = pl.af.f, y = predicted_response)) + geom_line() + labs(x = "Afternoon temperature (F)", y = "Dieback Probability") + scale_x_continuous(limits = c(80, 92.5),breaks=c(80,82.5,85,87.5,90,92.5)) + scale_y_continuous(limits = c(0, .3)) +theme_minimal()

p2 <- p + annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = -Inf, xmax = 84.32, fill = alpha('#DDA0DD',0.5)) +
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = 84.32, xmax = 88.5, fill = alpha('#7fcdbb',0.5)) + 
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
          xmin = 88.5, xmax = Inf, fill = alpha('#fe9929',0.5))
p3 <- p2 + annotate("text", x=82, y=.15, label= "Lowest\nConcern") + annotate("text", x=86.8, y=.15, label= "Moderate\nConcern") + annotate("text", x=91, y=.15, label= "Most\nConcern")
p3
```

The probability of a tree having top dieback increases with afternoon temperature



```{r}
p <- ggplot(data.top, aes(x=pl.af.f))+geom_histogram() +theme_bw() +labs(y="Number of Trees",x="Afternoon Temperature (F)")
p2 <- p + annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = -Inf, xmax = 84.32, fill = alpha('#DDA0DD',0.5)) +
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
              xmin = 84.32, xmax = 88.5, fill = alpha('#7fcdbb',0.5)) + 
    annotate(geom="rect",ymin = -Inf, ymax = Inf, 
          xmin = 88.5, xmax = Inf, fill = alpha('#fe9929',0.5))
p3 <- p2 + annotate("text", x=82.3, y=30, label= "Lowest\nConcern") + annotate("text", x=86.8, y=30, label= "Moderate\nConcern") + annotate("text", x=90.1, y=30, label= "Most\nConcern")
p3
```



---

## Response 3.0: healthy / thinning

```{r}
data.thin <- data %>% filter(reclassified.tree.canopy.symptoms=="Healthy"|reclassified.tree.canopy.symptoms=="Thinning Canopy") %>% droplevels()
```

```{r}
thinning.binomial.af <- glmmTMB(thinning ~ pl.af.f,data=data.thin,family=binomial)
```

### Summary

```{r}
summary(thinning.binomial.af)
```


```{r}
levels(data.thin$thinning)
str(data.thin$thinning)
```

There was no evidence the probability of a tree being classified as thinning is related to afternoon heat.  



### Visualize effects of predictors

First, generate predictions from model

```{r}
# Create a data frame for predictions
new.data.3 <- expand.grid(
  pl.af.f = seq(min(data.thin$pl.af.f), max(data.thin$pl.af.f), length.out = 100),  # keeping predictor2 constant at its mean
  Area = 0  # assuming random effect is zero for prediction
)
```

```{r}
new.data.3$predicted_response <- predict(thinning.binomial.af, newdata = new.data.3, type = "response")
```

```{r}
ggplot(new.data.3, aes(x = pl.af.f, y = predicted_response)) +
  geom_line() +
  labs(x = "Distance from Mean Temperature", y = "Dieback Probability") +
  theme_minimal()
```




